import os
import requests
import time
from dotenv import load_dotenv

# é€šç”¨APIè¯·æ±‚å‡½æ•°ï¼Œå‡å°‘é‡å¤ä»£ç 
def github_api_request(method, url, headers, data=None):
    response = getattr(requests, method)(url, headers=headers, json=data)
    response.raise_for_status()
    return response.json() if response.content else None

# åŠ è½½.envæ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡
def load_github_env():
    load_dotenv()
    github_token = os.getenv('github_token')
    github_owner = os.getenv('github_owner')
    github_repo = os.getenv('github_repo')
    
    if not all([github_token, github_owner, github_repo]):
        raise ValueError("è¯·ç¡®ä¿.envæ–‡ä»¶ä¸­åŒ…å«github_token, github_ownerå’Œgithub_repoå­—æ®µ")
    
    # åˆ›å»ºæ ‡å‡†è¯·æ±‚å¤´
    headers = {
        "Authorization": f"token {github_token}",
        "Accept": "application/vnd.github.v3+json"
    }
    
    return github_token, github_owner, github_repo, headers

# åˆ›å»ºä¸´æ—¶åˆ†æ”¯ï¼ˆåŸºäºmainåˆ†æ”¯å¹¶æ·»åŠ å·®å¼‚æäº¤ï¼‰
def create_temp_branch_with_diff(github_owner, github_repo, headers):
    # è·å–mainåˆ†æ”¯çš„æœ€æ–°commit SHA
    branch_data = github_api_request(
        'get',
        f"https://api.github.com/repos/{github_owner}/{github_repo}/branches/main",
        headers
    )
    latest_commit_sha = branch_data['commit']['sha']
    
    # ç”Ÿæˆä¸´æ—¶åˆ†æ”¯åç§°
    timestamp = int(time.time())
    temp_branch_name = f"temp-pr-branch-{timestamp}"
    
    # åˆ›å»ºä¸´æ—¶åˆ†æ”¯
    github_api_request(
        'post',
        f"https://api.github.com/repos/{github_owner}/{github_repo}/git/refs",
        headers,
        {"ref": f"refs/heads/{temp_branch_name}", "sha": latest_commit_sha}
    )
    
    print(f"âœ… ä¸´æ—¶åˆ†æ”¯ '{temp_branch_name}' åˆ›å»ºæˆåŠŸï¼")
    print(f"ğŸ”— åˆ†æ”¯åŸºäº: main çš„æœ€æ–°commit")
    
    # åˆ›å»ºä¸€ä¸ªç©ºçš„commitæ¥ç¡®ä¿ä¸´æ—¶åˆ†æ”¯ä¸mainåˆ†æ”¯æœ‰å·®å¼‚
    print("ğŸ”„ æ­£åœ¨æ·»åŠ å·®å¼‚æäº¤...")
    
    # è·å–commitä¿¡æ¯
    commit_data = github_api_request(
        'get',
        f"https://api.github.com/repos/{github_owner}/{github_repo}/git/commits/{latest_commit_sha}",
        headers
    )
    
    # åˆ›å»ºæ–°çš„ç©ºcommit
    new_commit = github_api_request(
        'post',
        f"https://api.github.com/repos/{github_owner}/{github_repo}/git/commits",
        headers,
        {
            "message": "Empty commit for PR creation",
            "parents": [latest_commit_sha],
            "tree": commit_data["tree"]["sha"]
        }
    )
    
    # æ›´æ–°ä¸´æ—¶åˆ†æ”¯æŒ‡å‘æ–°çš„commit
    github_api_request(
        'patch',
        f"https://api.github.com/repos/{github_owner}/{github_repo}/git/refs/heads/{temp_branch_name}",
        headers,
        {"sha": new_commit["sha"], "force": True}
    )
    
    print(f"âœ… å·²æ·»åŠ å·®å¼‚æäº¤ï¼Œç¡®ä¿ä¸´æ—¶åˆ†æ”¯ä¸mainåˆ†æ”¯æœ‰å·®å¼‚")
    return temp_branch_name

# åˆ›å»ºempty PR
def create_empty_pr(github_owner, github_repo, headers, title, head, base, body=""):
    # åˆ›å»ºPRï¼Œmaintainer_can_modify=Trueå…è®¸åˆ›å»ºæ— å·®å¼‚PR
    pr_data = github_api_request(
        'post',
        f"https://api.github.com/repos/{github_owner}/{github_repo}/pulls",
        headers,
        {
            "title": title,
            "head": head,  # æºåˆ†æ”¯ï¼ˆä¸´æ—¶åˆ†æ”¯ï¼Œæœ‰å·®å¼‚ï¼‰
            "base": base,  # ç›®æ ‡åˆ†æ”¯ï¼ˆç”¨æˆ·è¾“å…¥ï¼‰
            "body": body,
            "draft": False,
            "maintainer_can_modify": True
        }
    )
    
    print(f"âœ… PRåˆ›å»ºæˆåŠŸ!")
    print(f"ğŸ”— PRé“¾æ¥: {pr_data['html_url']}")
    print(f"ğŸ“ PRæ ‡é¢˜: {pr_data['title']}")
    print(f"ğŸ‘¤ åˆ›å»ºè€…: {pr_data['user']['login']}")
    
    return pr_data

# ä¸»å‡½æ•°
def main():
    try:
        # åŠ è½½GitHubç¯å¢ƒå˜é‡å’Œè¯·æ±‚å¤´
        github_token, github_owner, github_repo, headers = load_github_env()
        
        print("ğŸŒŸ GitHubè‡ªåŠ¨åˆ›å»ºEmpty PRå·¥å…·")
        print(f"ğŸ”§ æ­£åœ¨è¿æ¥åˆ°ä»“åº“: {github_owner}/{github_repo}")
        
        # è·å–ç”¨æˆ·è¾“å…¥
        title = input("\nè¯·è¾“å…¥PRæ ‡é¢˜: ")
        target_branch = input("è¯·è¾“å…¥è¦åˆå¹¶åˆ°çš„ç›®æ ‡åˆ†æ”¯å: ")
        
        # åˆ›å»ºåŸºäºmainåˆ†æ”¯çš„ä¸´æ—¶åˆ†æ”¯ï¼ˆä½œä¸ºæºåˆ†æ”¯ï¼ŒåŒ…å«å·®å¼‚ï¼‰
        print("\nğŸ”„ æ­£åœ¨åˆ›å»ºä¸´æ—¶åˆ†æ”¯å¹¶æ·»åŠ å·®å¼‚æäº¤...")
        source_branch = create_temp_branch_with_diff(github_owner, github_repo, headers)
        
        body = input("è¯·è¾“å…¥PRæè¿° (å¯é€‰ï¼Œç›´æ¥å›è½¦è·³è¿‡): ")
        
        # åˆ›å»ºPRï¼šä»ä¸´æ—¶åˆ†æ”¯(source_branch)åˆå¹¶åˆ°ç”¨æˆ·æŒ‡å®šçš„ç›®æ ‡åˆ†æ”¯(target_branch)
        create_empty_pr(github_owner, github_repo, headers, title, source_branch, target_branch, body)
        
    except Exception as e:
        print(f"âŒ ç¨‹åºæ‰§è¡Œå‡ºé”™: {e}")
        # æå–æ›´å…·ä½“çš„é”™è¯¯ä¿¡æ¯
        if hasattr(e, 'response') and hasattr(e.response, 'content') and e.response.content:
            try:
                error_data = e.response.json()
                print(f"ğŸ“‹ é”™è¯¯è¯¦æƒ…: {error_data}")
                
                # å¸¸è§é”™è¯¯æç¤º
                if 'errors' in error_data:
                    for err in error_data['errors']:
                        if err.get('code') == 'custom' and 'No commits between' in err.get('message', ''):
                            print("ğŸ’¡ æç¤º: ä¸¤ä¸ªåˆ†æ”¯ä¹‹é—´æ²¡æœ‰å¯æ£€æµ‹çš„å·®å¼‚")
            except:
                pass
        
        print("ğŸ’¡ å»ºè®®æ£€æŸ¥:")
        print("  1. .envæ–‡ä»¶ä¸­çš„GitHubä¿¡æ¯æ˜¯å¦æ­£ç¡®")
        print("  2. ä»“åº“ä¸­æ˜¯å¦å­˜åœ¨mainåˆ†æ”¯")
        print("  3. GitHub Tokenæ˜¯å¦æœ‰è¶³å¤Ÿçš„æƒé™")

if __name__ == "__main__":
    main()
